## Codebase Patterns
- Ralph service types are in `crates/services/src/services/ralph.rs`
- API response types are separate from service types - check `crates/server/src/routes/tasks.rs` for `RalphStatusResponse`
- When adding fields to service types, also update the corresponding API response types
- Run `pnpm run generate-types` after changing any TS-exported Rust types
- Typecheck with `pnpm run check` (runs both frontend and backend checks)

---

## 2026-01-23 - US-001
- Added `started` (bool, default false) and `iteration_prompt` (Option<String>) fields to PrdFile struct
- Added same fields to RalphStatus struct (exposed via TS)
- Updated RalphStatusResponse in tasks.rs with the new fields
- Added 2 new tests: `test_get_status_with_started_and_iteration_prompt` and `test_get_status_defaults_started_to_false`
- Regenerated TypeScript types

**Files changed:**
- `crates/services/src/services/ralph.rs` - Added fields to PrdFile and RalphStatus, added tests
- `crates/server/src/routes/tasks.rs` - Added fields to RalphStatusResponse and both struct initializers
- `shared/types.ts` - Auto-generated, now includes `started` and `iteration_prompt`

**Learnings for future iterations:**
- The service layer (ralph.rs) has internal types, but the API layer (tasks.rs) has its own response types that map from the service types
- Both places need updating when adding fields that should be exposed to the frontend
---

## 2026-01-23 - US-002
- Updated prompt generation logic in `container.rs` for Ralph tasks
- Two locations updated:
  1. Auto-continue logic (line ~398): Uses `status.started` and `status.iteration_prompt` from already-fetched RalphStatus
  2. Initial request logic (line ~1211): Fetches RalphStatus to check started state before generating prompt
- If `started=true`: Uses `iterationPrompt` from prd.json or default "Read .ralph/prompt.md and continue implementing the PRD."
- If `started=false` or prd.json missing: Uses original `task.description` (interactive mode)

**Files changed:**
- `crates/services/src/services/container.rs` - Updated prompt logic in `try_ralph_auto_continue` and `start_workspace`

**Learnings for future iterations:**
- In auto-continue, the RalphStatus is already fetched for checkpoint/completion checks, so reuse it for prompt logic
- In initial request, need to construct repo path from workspace.container_ref + repo.name to call RalphService
---

## 2026-01-23 - US-003
- Updated `continue_ralph_execution` endpoint in `tasks.rs` to check for prd.json existence
- Changed error handling from generic `map_err` to explicit match on `RalphError::PrdNotFound`
- Returns specific error message: "PRD not ready yet. Create prd.json first."
- Also updated prompt logic to use `status.started` and `status.iteration_prompt` for consistency with container.rs

**Files changed:**
- `crates/server/src/routes/tasks.rs` - Updated continue_ralph_execution with PrdNotFound check and prompt logic

**Learnings for future iterations:**
- The `continue_ralph_execution` endpoint is a third place where prompt logic exists (alongside container.rs auto-continue and start_workspace)
- All three places now consistently check `status.started` and use `iteration_prompt` when appropriate
---
